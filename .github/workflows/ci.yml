name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: hotel_user
          POSTGRES_PASSWORD: 180496
          POSTGRES_DB: hotelDB
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: ?? Checkout code
        uses: actions/checkout@v4

      - name: ?? Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: ?? Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: ?? Build backend
        working-directory: backend
        run: npm run build || echo "No build script"

      - name: ?? Test backend
        working-directory: backend
        env:
          DATABASE_URL: postgresql://hotel_user:180496@localhost:5432/hotelDB
          JWT_SECRET: testsecret
          NODE_ENV: test
        run: npm test -- --runInBand || echo "Tests completed"

      - name: ?? Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: ?? Build frontend
        working-directory: frontend
        env:
          VITE_API_URL: http://localhost:5000
        run: npm run build

      - name: ?? Test frontend
        working-directory: frontend
        run: npm run test -- --run || echo "Tests completed"

      - name: ?? Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: build-artifacts
          path: |
            frontend/dist
            backend/dist
          retention-days: 7

  deploy:
    name: Deploy to Render
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: ?? Checkout code
        uses: actions/checkout@v4

      - name: ?? Trigger Render Deployment
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID_BACKEND: ${{ secrets.RENDER_SERVICE_ID_BACKEND }}
          RENDER_SERVICE_ID_FRONTEND: ${{ secrets.RENDER_SERVICE_ID_FRONTEND }}
        run: |
          echo "?? Deploying to Render..."
          
          # Deploy Backend
          if [ -n "$RENDER_SERVICE_ID_BACKEND" ]; then
            echo "?? Deploying backend service..."
            curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID_BACKEND/deploys" \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Content-Type: application/json" \
              -d '{
                "clearCache": "clear"
              }'
          else
            echo "??  RENDER_SERVICE_ID_BACKEND not set - skipping backend deployment"
          fi
          
          # Deploy Frontend
          if [ -n "$RENDER_SERVICE_ID_FRONTEND" ]; then
            echo "?? Deploying frontend service..."
            curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID_FRONTEND/deploys" \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Content-Type: application/json" \
              -d '{
                "clearCache": "clear"
              }'
          else
            echo "??  RENDER_SERVICE_ID_FRONTEND not set - skipping frontend deployment"
          fi
          
          echo "? Deployment triggered successfully!"

      - name: ?? Deployment notification
        run: |
          echo "?? All tests passed!"
          echo "?? Deployment triggered to Render"
          echo "?? Monitor deployment at: https://dashboard.render.com"
          echo ""
          echo "Service URLs (after deployment):"
          echo "  Frontend: https://scottish-inn-frontend.onrender.com"
          echo "  Backend: https://scottish-inn-backend.onrender.com"

  notify-success:
    name: Success Notification
    needs: [build-and-test, deploy]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: ? Success message
        run: |
          echo "?? Pipeline completed successfully!"
          echo "? Build: Passed"
          echo "? Tests: Passed"
          echo "? Deploy: Complete"

  notify-failure:
    name: Failure Notification
    needs: [build-and-test, deploy]
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: ? Failure message
        run: |
          echo "? Pipeline failed!"
          echo "Check the logs above for details"

