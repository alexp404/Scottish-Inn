# ?? Deployment Guide - Scottish Inn & Suites

## Overview
This guide covers automated deployment of the Scottish Inn Hotel Management System to Render.com using GitHub Actions.

---

## ?? Table of Contents
- [Architecture](#architecture)
- [Prerequisites](#prerequisites)
- [Initial Setup](#initial-setup)
- [Automated Deployment](#automated-deployment)
- [Manual Deployment](#manual-deployment)
- [Environment Variables](#environment-variables)
- [Monitoring](#monitoring)
- [Troubleshooting](#troubleshooting)

---

## ??? Architecture

```
???????????????????????????????????????????????????????????????
?                    Deployment Pipeline                       ?
???????????????????????????????????????????????????????????????

1. Code Push to GitHub (master branch)
   ?
2. GitHub Actions Workflow Triggered
   ?
3. Build & Test Phase
   ??? Backend: npm install ? build ? test
   ??? Frontend: npm install ? build ? test
   ??? Artifacts uploaded
   ?
4. Deployment Phase (if tests pass)
   ??? Trigger Render API for Backend
   ??? Trigger Render API for Frontend
   ?
5. Render Builds & Deploys
   ??? Backend: Node.js service
   ??? Frontend: Static site
   ??? Database: PostgreSQL
   ?
6. Live Application
   Frontend: https://scottish-inn-frontend.onrender.com
   Backend: https://scottish-inn-backend.onrender.com
```

---

## ? Prerequisites

### Required Accounts
- ? GitHub account with repository access
- ? Render.com account (free tier works)
- ? Stripe account (for payments)
- ? SendGrid account (for emails - optional)

### Required Tools
- Git (version 2.0+)
- Node.js (version 20+)
- npm (version 9+)

---

## ?? Initial Setup

### Step 1: Create Render Account
1. Go to [Render.com](https://render.com)
2. Sign up with GitHub
3. Authorize Render to access your repository

### Step 2: Connect Repository
1. In Render Dashboard ? **New** ? **Blueprint**
2. Select your `Scottish-Inn` repository
3. Render will detect the `render.yaml` file
4. Click **Apply** to create all services

### Step 3: Get Render API Credentials

#### Get API Key:
```bash
# 1. Go to Render Dashboard
# 2. Click your avatar ? Account Settings
# 3. Navigate to "API Keys"
# 4. Click "Create API Key"
# 5. Copy the key (starts with rnd_...)
```

#### Get Service IDs:
```bash
# 1. Go to each service in Render Dashboard
# 2. Look at the URL: https://dashboard.render.com/web/srv-XXXXX
# 3. Copy the srv-XXXXX part (this is your Service ID)
```

### Step 4: Configure GitHub Secrets

1. Go to your GitHub repository
2. Navigate to **Settings** ? **Secrets and variables** ? **Actions**
3. Click **New repository secret**
4. Add the following secrets:

```
RENDER_API_KEY
  Value: rnd_xxxxxxxxxxxxxxxxxxxxxxxxxx

RENDER_SERVICE_ID_BACKEND
  Value: srv-xxxxxxxxxxxxxxxxxxxxx

RENDER_SERVICE_ID_FRONTEND
  Value: srv-xxxxxxxxxxxxxxxxxxxxx
```

### Step 5: Configure Environment Variables in Render

#### Backend Service Environment Variables:
```bash
# Required (Auto-generated by render.yaml)
NODE_ENV=production
PORT=5000
DATABASE_URL=postgresql://... (auto-linked)
JWT_SECRET=... (auto-generated)
ADMIN_TOKEN=... (auto-generated)

# Required (Manual setup)
FRONTEND_URL=https://scottish-inn-frontend.onrender.com

# Email Configuration (Optional - SendGrid)
EMAIL_FROM=frontdesk@scottishinn1960.com
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=465
SMTP_USER=apikey
SENDGRID_API_KEY=SG.xxxxxxxxx

# Payment Configuration (Required for payments)
STRIPE_SECRET_KEY=sk_test_xxxxxx
STRIPE_PUBLISHABLE_KEY=pk_test_xxxxxx

# Application
APP_NAME=Scottish Inn & Suites
```

#### Frontend Service Environment Variables:
```bash
# Required
VITE_API_URL=https://scottish-inn-backend.onrender.com

# Payment Configuration
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_xxxxxx
```

---

## ?? Automated Deployment

### How It Works

1. **Trigger**: Push to `master` or `main` branch
2. **Build**: GitHub Actions builds and tests code
3. **Deploy**: Automatically triggers Render deployment
4. **Monitor**: Check status in Render Dashboard

### Deployment Flow

```bash
git add .
git commit -m "Your commit message"
git push origin master

# GitHub Actions will:
# ? Build backend
# ? Test backend
# ? Build frontend
# ? Test frontend
# ? Trigger Render deployment
# ? Deploy to production
```

### View Deployment Status

1. **GitHub Actions**: 
   - Go to repository ? **Actions** tab
   - View workflow progress

2. **Render Dashboard**:
   - Go to https://dashboard.render.com
   - View each service's deployment logs

---

## ?? Manual Deployment

### Option 1: Render Dashboard
```bash
# 1. Go to Render Dashboard
# 2. Select service (backend or frontend)
# 3. Click "Manual Deploy" ? "Deploy latest commit"
```

### Option 2: Render CLI
```bash
# Install Render CLI
npm install -g @render/cli

# Login
render login

# Deploy backend
render deploy --service scottish-inn-backend

# Deploy frontend
render deploy --service scottish-inn-frontend
```

### Option 3: API Call
```bash
# Backend
curl -X POST "https://api.render.com/v1/services/srv-XXXXX/deploys" \
  -H "Authorization: Bearer $RENDER_API_KEY" \
  -H "Content-Type: application/json"

# Frontend
curl -X POST "https://api.render.com/v1/services/srv-XXXXX/deploys" \
  -H "Authorization: Bearer $RENDER_API_KEY" \
  -H "Content-Type: application/json"
```

---

## ?? Environment Variables

### Backend (.env)
```bash
# Database
DATABASE_URL=postgresql://hotel_user:password@host:5432/hotelDB

# Security
NODE_ENV=production
JWT_SECRET=your_secure_random_string_here
ADMIN_TOKEN=your_admin_secret_token

# API
PORT=5000
FRONTEND_URL=https://scottish-inn-frontend.onrender.com

# Email (SendGrid)
EMAIL_FROM=frontdesk@scottishinn1960.com
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=465
SMTP_USER=apikey
SENDGRID_API_KEY=SG.your_sendgrid_api_key

# Payments (Stripe)
STRIPE_SECRET_KEY=sk_live_or_test_key
STRIPE_PUBLISHABLE_KEY=pk_live_or_test_key

# App
APP_NAME=Scottish Inn & Suites
```

### Frontend (.env)
```bash
VITE_API_URL=https://scottish-inn-backend.onrender.com
VITE_STRIPE_PUBLISHABLE_KEY=pk_live_or_test_key
```

---

## ?? Monitoring

### Health Checks

#### Backend Health Check:
```bash
curl https://scottish-inn-backend.onrender.com/api/health

# Expected Response:
{
  "status": "ok",
  "timestamp": "2024-01-15T10:30:00.000Z",
  "uptime": 12345
}
```

#### Frontend Check:
```bash
curl https://scottish-inn-frontend.onrender.com

# Should return HTML with status 200
```

### Logs

#### View Logs in Render:
1. Go to service in Render Dashboard
2. Click **Logs** tab
3. Filter by time/level

#### View Logs via CLI:
```bash
render logs --service scottish-inn-backend --tail
render logs --service scottish-inn-frontend --tail
```

### Monitoring Endpoints

```bash
# Backend API Status
GET /api/health

# Database Connection
GET /api/stats (requires admin auth)

# Room Availability
GET /api/rooms
```

---

## ?? Troubleshooting

### Common Issues

#### 1. Build Fails
```bash
# Check:
? Node version in render.yaml matches local
? All dependencies in package.json
? Build command is correct
? Environment variables are set

# Solution:
# Review build logs in Render Dashboard
# Test locally: npm run build
```

#### 2. Database Connection Failed
```bash
# Check:
? DATABASE_URL is set correctly
? Database service is running
? Connection string format is correct

# Solution:
# Verify in Render Dashboard ? Environment
# Check database service status
```

#### 3. CORS Errors
```bash
# Check:
? FRONTEND_URL matches actual frontend URL
? Backend CORS configuration
? No trailing slashes in URLs

# Solution:
# Update backend/src/index.ts CORS settings
# Redeploy backend
```

#### 4. Environment Variables Not Loading
```bash
# Check:
? Variables are set in Render Dashboard
? Service has been redeployed after adding vars
? Variable names match exactly (case-sensitive)

# Solution:
# Redeploy service after changing env vars
```

#### 5. GitHub Actions Deployment Fails
```bash
# Check:
? RENDER_API_KEY is valid
? Service IDs are correct
? Secrets are set in GitHub

# Solution:
# Regenerate API key in Render
# Update GitHub secrets
# Re-run workflow
```

---

## ?? Deployment Workflow

### Development to Production Flow

```bash
# 1. Local Development
git checkout -b feature/new-feature
# Make changes
npm run dev

# 2. Test Locally
npm test
npm run build

# 3. Commit & Push
git add .
git commit -m "Add new feature"
git push origin feature/new-feature

# 4. Create Pull Request
# GitHub ? New PR ? Request review

# 5. Merge to Master
# Tests run automatically
# Deployment triggers on merge

# 6. Monitor Deployment
# GitHub Actions ? View workflow
# Render Dashboard ? View logs

# 7. Verify Production
# Visit: https://scottish-inn-frontend.onrender.com
# Test functionality
```

---

## ?? Scaling

### Free Tier Limits (Render)
- 750 hours/month per service
- Sleeps after 15 mins of inactivity
- 100 GB bandwidth/month

### Upgrade Options

#### Starter Plan ($7/month per service)
- Always on (no sleep)
- Better performance
- Custom domains

#### Professional Plan ($25/month per service)
- 4GB RAM
- Faster builds
- Priority support

---

## ?? Security Best Practices

### 1. Environment Variables
```bash
? Never commit .env files
? Use GitHub Secrets for sensitive data
? Rotate API keys regularly
? Use different keys for dev/prod
```

### 2. Database
```bash
? Use strong passwords
? Enable SSL connections
? Regular backups
? Limit access by IP (if possible)
```

### 3. API Keys
```bash
? Stripe: Use test keys in development
? SendGrid: Restrict sender permissions
? JWT: Use long, random secrets
```

---

## ?? Deployment Checklist

### Pre-Deployment
- [ ] All tests passing locally
- [ ] Environment variables configured
- [ ] Database migrations ready
- [ ] API keys valid
- [ ] CORS settings correct

### Deployment
- [ ] Code pushed to master
- [ ] GitHub Actions workflow succeeded
- [ ] Render builds completed
- [ ] Services are healthy

### Post-Deployment
- [ ] Frontend loads correctly
- [ ] Backend API responding
- [ ] Database connected
- [ ] Email sending works
- [ ] Payments processing
- [ ] Monitor logs for errors

---

## ?? Support

### Resources
- **Render Docs**: https://render.com/docs
- **GitHub Actions**: https://docs.github.com/actions
- **Project Issues**: https://github.com/alexp404/Scottish-Inn/issues

### Contact
- **Email**: support@scottishinn1960.com
- **Phone**: (281) 821-9900

---

## ?? Additional Documentation

- [SIGNUP_INTEGRATION.md](./SIGNUP_INTEGRATION.md) - Signup feature details
- [SIGNUP_TESTING_GUIDE.md](./SIGNUP_TESTING_GUIDE.md) - Testing procedures
- [README.md](./README.md) - Project overview

---

**Last Updated**: 2024-01-15  
**Version**: 1.0.0  
**Status**: ? Production Ready
